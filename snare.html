<!DOCTYPE html>

<html>
  <head>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.2.0/socket.io.js"></script>
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      .main {
        background-color: grey;
        margin: 0;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }
    </style>
  </head>

  <body>
    <button id="record-button">Record: off</button>
    <button id="record-play">Play</button>
    <div id="main" class="main">
      <div class="snare" id="snare"></div>

      <audio
        id="C"
        src="https://cdn.glitch.global/1ea1ca4a-613c-41b7-9fdc-6415548f138f/A.mp3?v=1668646643698"
      ></audio>
      <audio
        id="Db"
        src="https://cdn.glitch.global/1ea1ca4a-613c-41b7-9fdc-6415548f138f/Db.mp3?v=1668646658424"
      ></audio>
      <audio
        id="D"
        src="https://cdn.glitch.global/1ea1ca4a-613c-41b7-9fdc-6415548f138f/D.mp3?v=1668646656583"
      ></audio>
      <audio
        id="Eb"
        src="https://cdn.glitch.global/1ea1ca4a-613c-41b7-9fdc-6415548f138f/Eb.mp3?v=1668646665661"
      ></audio>
      <audio
        id="E"
        src="https://cdn.glitch.global/1ea1ca4a-613c-41b7-9fdc-6415548f138f/E.mp3?v=1668646661569"
      ></audio>
      <audio
        id="F"
        src="https://cdn.glitch.global/1ea1ca4a-613c-41b7-9fdc-6415548f138f/F.mp3?v=1668646667543"
      ></audio>
      <audio
        id="Gb"
        src="https://cdn.glitch.global/1ea1ca4a-613c-41b7-9fdc-6415548f138f/Gb.mp3?v=1668646670405"
      ></audio>
      <audio
        id="G"
        src="https://cdn.glitch.global/1ea1ca4a-613c-41b7-9fdc-6415548f138f/G.mp3?v=1668646668876"
      ></audio>
      <audio
        id="Ab"
        src="https://cdn.glitch.global/1ea1ca4a-613c-41b7-9fdc-6415548f138f/Ab.mp3?v=1668646648995"
      ></audio>
      <audio
        id="A"
        src="https://cdn.glitch.global/1ea1ca4a-613c-41b7-9fdc-6415548f138f/A.mp3?v=1668646643698"
      ></audio>
      <audio
        id="Bb"
        src="https://cdn.glitch.global/1ea1ca4a-613c-41b7-9fdc-6415548f138f/Bb.mp3?v=1668646652265"
      ></audio>
      <audio
        id="B"
        src="https://cdn.glitch.global/1ea1ca4a-613c-41b7-9fdc-6415548f138f/B.mp3?v=1668646650319"
      ></audio>
    </div>
    <script>
      //init socket
      var socket = io();

      //connect to your server address
      socket.connect("https://collaborative-piano.glitch.me/:3000");

      //when a text is recieved...
      socket.on("key", (d) => {
        console.log("recieving: " + d.key);

        if (d.whiteKeyIndex > -1) {
          piano(whiteKeys[d.whiteKeyIndex]);
        }
        if (d.blackKeyIndex > -1) {
          piano(blackKeys[d.blackKeyIndex]);
        }
      });

      const WHITE_KEYS = ["z", "x", "c", "v", "b", "n", "m"];
      const BLACK_KEYS = ["s", "d", "g", "h", "j"];

      const keys = document.querySelectorAll(".key");
      const whiteKeys = document.querySelectorAll(".key.white");
      const blackKeys = document.querySelectorAll(".key.black");

      document
        .getElementById("record-button")
        .addEventListener("click", (e) => {
          if (recording) {
            document.getElementById("record-button").innerHTML = "Record: off";
          } else {
            document.getElementById("record-button").innerHTML = "Record: on";
          }
          recording = !recording;
        });

      document.getElementById("record-play").addEventListener("click", (e) => {
        if (playingRecording) {
          document.getElementById("record-play").innerHTML = "Play";
          playingRecording = !playingRecording;
        } else {
          document.getElementById("record-play").innerHTML = "Pause";
          playingRecording = !playingRecording;
          playRecording();
        }
      });

      function playNote(key) {
        const noteAudio = document.getElementById(key.dataset.note);
        noteAudio.currentTime = 0;
        noteAudio.play();
        key.classList.add("active");
        noteAudio.addEventListener("ended", () => {
          key.classList.remove("active");
        });
      }

      function piano(key) {
        const noteAudio = document.getElementById(key.dataset.note);
        noteAudio.currentTime = 0;
        noteAudio.play();
      }

      async function playRecording() {
        //const myWorker = new Worker("looper.js");
        //myWorker.postMessage(recordedNotes);
        let currentNote = 0;
        while (playingRecording) {
          if (recordedNotes[currentNote].whiteKeyIndex > -1) {
            playNote(whiteKeys[recordedNotes[currentNote].whiteKeyIndex]);
          }
          if (recordedNotes[currentNote].blackKeyIndex > -1) {
            playNote(blackKeys[recordedNotes[currentNote].blackKeyIndex]);
          }
          currentNote++;
          if (currentNote >= recordedNotes.length) {
            currentNote = 0;
          }
          await sleep(500);
        }
      }

      function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      const piano =
        "https://cdn.glitch.me/79cb0af8-289f-4799-9190-fc33be9edede%2Fdownload.jpg?v=1638296175995";
      const snare =
        "https://cdn.glitch.me/79cb0af8-289f-4799-9190-fc33be9edede%2F7bc0dee81fff44819463baea6d7e3c2c.jpg?v=1638296153357";
      const tambourine =
        "https://cdn.glitch.me/79cb0af8-289f-4799-9190-fc33be9edede%2F7bc0dee81fff44819463baea6d7e3c2c.jpg?v=1638296153357";

      //figure out who this client is, this is for styling in the chatting application
      var me;
      var address = window.location.href;
      var who = address.substring(address.lastIndexOf("/") + 1);
      var recordedNotes = [];
      var playingRecording = false;
      var recording = false;

      if (who === "piano") {
        console.log("piano");
        me = {
          id: "piano",
          img: piano,
        };
      }
      if (who === "snare") {
        console.log("snare");
        me = {
          id: "snare",
          img: snare,
        };
      }
      if (who === "tambourine") {
        console.log("tambourine");
        var element = document.getElementById("piano");
        element.style.display = "none";
        me = {
          id: "tambourine",
          img: tambourine,
        };
      }
    </script>
  </body>
</html>
